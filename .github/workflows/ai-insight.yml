name: Generate AI Insight

on:
  schedule:
    - cron: '0 21 * * *'  # í•˜ë£¨ 1ë²ˆ (UTC 21:00 â†’ KST 06:00)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write

concurrency:
  group: ai-insight
  cancel-in-progress: false

jobs:
  generate-insight:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Pull latest changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git pull origin main --rebase || true

      - name: Check cache file
        id: check-cache
        run: |
          if [ -f "data-cache.json" ]; then
            echo "cache_exists=true" >> $GITHUB_OUTPUT
            echo "ğŸ“‚ ìºì‹œ íŒŒì¼ ì¡´ì¬ í™•ì¸"
          else
            echo "cache_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ ìºì‹œ íŒŒì¼ ì—†ìŒ - build ì›Œí¬í”Œë¡œìš°ê°€ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤"
          fi

      - name: Setup Node.js
        if: steps.check-cache.outputs.cache_exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        if: steps.check-cache.outputs.cache_exists == 'true'
        run: npm install --production

      - name: Generate AI Insight
        if: steps.check-cache.outputs.cache_exists == 'true'
        run: |
          export PATH="/opt/homebrew/bin:$PATH"
          echo "ğŸ¤– AI ì¸ì‚¬ì´íŠ¸ ìƒì„± ì‹œì‘..."
          node generate-ai-insight.js
        timeout-minutes: 30

      - name: Finalize AI thumbnails (Codex)
        if: steps.check-cache.outputs.cache_exists == 'true'
        run: |
          export PATH="/opt/homebrew/bin:$PATH"
          echo "ğŸ–¼ï¸ AI ì¸ë„¤ì¼ í›„ì²˜ë¦¬(Codex) ì‹œì‘..."
          command -v codex >/dev/null 2>&1 || { echo "âŒ codex CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"; exit 1; }
          TARGET_FILE="$(node - <<-'NODE'
          const fs = require('fs');
          const path = require('path');

          const kst = new Date(Date.now() + 9 * 60 * 60 * 1000);
          const date = kst.toISOString().slice(0, 10);
          const candidates = [
            `reports/${date}.json`,
            `reports/${date}-AM.json`,
            `reports/${date}-PM.json`,
          ];

          const existing = candidates.find(f => fs.existsSync(f));
          if (existing) {
            console.log(existing);
            process.exit(0);
          }

          if (fs.existsSync('reports')) {
            const files = fs.readdirSync('reports')
              .filter(f => /^\d{4}-\d{2}-\d{2}(-[AP]M)?\.json$/.test(f))
              .map(f => path.join('reports', f));
            files.sort((a, b) => fs.statSync(b).mtimeMs - fs.statSync(a).mtimeMs);
            if (files[0]) {
              console.log(files[0]);
              process.exit(0);
            }
          }

          console.error('No report file found');
          process.exit(1);
          	NODE
          )"
          echo "ğŸ¯ ëŒ€ìƒ ë¦¬í¬íŠ¸: $TARGET_FILE"
          cat <<-PROMPT | codex exec -m gpt-5.2 -c model_reasoning_effort=high -c hide_agent_reasoning=true --dangerously-bypass-approvals-and-sandbox -
          ë‹¤ìŒ JSON íŒŒì¼ì˜ ì¸ë„¤ì¼ URLì„ ì›¹ ê²€ìƒ‰ìœ¼ë¡œ ì •í™•íˆ ì±„ì›Œì£¼ì„¸ìš”.
          íŒŒì¼: ${TARGET_FILE}

          ëŒ€ìƒ í•„ë“œ(ì´ì™¸ ìˆ˜ì • ê¸ˆì§€):
          - ai.thumbnail
          - ai.issues[].thumbnail
          - ai.industryIssues[].thumbnail
          - ai.metrics[].thumbnail

          ê·œì¹™:
          - thumbnailì€ ë°˜ë“œì‹œ https:// ë¡œ ì‹œì‘í•˜ëŠ” ì ˆëŒ€ URLë§Œ ì‚¬ìš©(// ê¸ˆì§€)
          - ì œëª©/ë‚´ìš©ê³¼ í™•ì‹¤íˆ ì¼ì¹˜í•˜ëŠ” ê¸°ì‚¬/ê³µì‹ ì´ë¯¸ì§€ë§Œ ì‚¬ìš©í•˜ê³ , ì• ë§¤í•˜ë©´ null ìœ ì§€
          - ë‹¤ë¥¸ í•„ë“œ/í‚¤ ìˆœì„œ/ì„œì‹ì€ ê±´ë“œë¦¬ì§€ ë§ ê²ƒ
          - git ëª…ë ¹ì€ ì ˆëŒ€ ì‹¤í–‰í•˜ì§€ ë§ ê²ƒ
          	PROMPT
        timeout-minutes: 30

      - name: Move reports to docs
        if: steps.check-cache.outputs.cache_exists == 'true'
        run: |
          mkdir -p docs/reports
          if [ -d "reports" ]; then
            cp -r reports/*.json docs/reports/ 2>/dev/null || true
            cp -r reports/*.html docs/reports/ 2>/dev/null || true
          fi

      - name: Commit and push
        if: steps.check-cache.outputs.cache_exists == 'true'
        run: |
          # ë¨¼ì € stashí•˜ê³  pull
          git stash --include-untracked || true
          git pull origin main --rebase || true
          git stash pop || true
          # ê·¸ ë‹¤ìŒ add & commit
          git add reports/ docs/reports/
          if git diff --staged --quiet; then
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            git commit -m "AI Insight $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "âœ… AI ì¸ì‚¬ì´íŠ¸ í‘¸ì‹œ ì™„ë£Œ"
          fi

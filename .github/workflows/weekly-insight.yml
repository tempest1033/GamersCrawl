name: Generate Weekly Insight

on:
  schedule:
    - cron: '0 18 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ UTC 18:00 â†’ KST ì›”ìš”ì¼ 03:00
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      force:
        description: 'ê°•ì œ ì¬ìƒì„± (ê¸°ì¡´ ë¦¬í¬íŠ¸ ë®ì–´ì“°ê¸°)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

concurrency:
  group: weekly-insight
  cancel-in-progress: false

jobs:
  generate-weekly-insight:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Pull latest changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git pull origin main --rebase || true

      - name: Check daily reports
        id: check-reports
        run: |
          REPORTS_COUNT=$(ls -1 reports/2*.json 2>/dev/null | wc -l)
          if [ "$REPORTS_COUNT" -gt 0 ]; then
            echo "reports_exist=true" >> $GITHUB_OUTPUT
            echo "ğŸ“‚ ì¼ì¼ ë¦¬í¬íŠ¸ ${REPORTS_COUNT}ê°œ í™•ì¸"
          else
            echo "reports_exist=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ ì¼ì¼ ë¦¬í¬íŠ¸ ì—†ìŒ - ai-insight ì›Œí¬í”Œë¡œìš°ê°€ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤"
          fi

      - name: Setup Node.js
        if: steps.check-reports.outputs.reports_exist == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        if: steps.check-reports.outputs.reports_exist == 'true'
        run: npm install --production

      - name: Generate Weekly Insight
        if: steps.check-reports.outputs.reports_exist == 'true'
        run: |
          export PATH="/opt/homebrew/bin:$PATH"
          echo "ğŸ“… ì£¼ê°„ ì¸ì‚¬ì´íŠ¸ ìƒì„± ì‹œì‘..."
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            node generate-weekly-insight.js --force
          else
            node generate-weekly-insight.js
          fi
        timeout-minutes: 30

      - name: Finalize Weekly thumbnails (Codex)
        if: steps.check-reports.outputs.reports_exist == 'true'
        run: |
          export PATH="/opt/homebrew/bin:$PATH"
          echo "ğŸ–¼ï¸ ì£¼ê°„ ì¸ë„¤ì¼ í›„ì²˜ë¦¬(Codex) ì‹œì‘..."
          command -v codex >/dev/null 2>&1 || { echo "âŒ codex CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"; exit 1; }
          TARGET_FILE="$(ls -t reports/weekly/*.json 2>/dev/null | head -n 1)"
          if [ -z "$TARGET_FILE" ]; then
            echo "âŒ ì£¼ê°„ ë¦¬í¬íŠ¸ íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ (reports/weekly/*.json)"
            exit 1
          fi
          echo "ğŸ¯ ëŒ€ìƒ ë¦¬í¬íŠ¸: $TARGET_FILE"
          cat <<-PROMPT | codex exec -m gpt-5.2 -c model_reasoning_effort=high -c hide_agent_reasoning=true --dangerously-bypass-approvals-and-sandbox -
          ë‹¤ìŒ JSON íŒŒì¼ì˜ ì¸ë„¤ì¼ URLì„ ì›¹ ê²€ìƒ‰ìœ¼ë¡œ ì •í™•íˆ ì±„ì›Œì£¼ì„¸ìš”.
          íŒŒì¼: ${TARGET_FILE}

          ëŒ€ìƒ í•„ë“œ(ì´ì™¸ ìˆ˜ì • ê¸ˆì§€):
          - ai.thumbnail
          - ai.issues[].thumbnail
          - ai.industryIssues[].thumbnail
          - ai.metrics[].thumbnail
          - ai.global[].thumbnail

          ê·œì¹™:
          - thumbnailì€ ë°˜ë“œì‹œ https:// ë¡œ ì‹œì‘í•˜ëŠ” ì ˆëŒ€ URLë§Œ ì‚¬ìš©(// ê¸ˆì§€)
          - ì œëª©/ë‚´ìš©ê³¼ í™•ì‹¤íˆ ì¼ì¹˜í•˜ëŠ” ê¸°ì‚¬/ê³µì‹ ì´ë¯¸ì§€ë§Œ ì‚¬ìš©í•˜ê³ , ì• ë§¤í•˜ë©´ null ìœ ì§€
          - ë‹¤ë¥¸ í•„ë“œ/í‚¤ ìˆœì„œ/ì„œì‹ì€ ê±´ë“œë¦¬ì§€ ë§ ê²ƒ
          - git ëª…ë ¹ì€ ì ˆëŒ€ ì‹¤í–‰í•˜ì§€ ë§ ê²ƒ
          	PROMPT
        timeout-minutes: 30

      - name: Move weekly reports to docs
        if: steps.check-reports.outputs.reports_exist == 'true'
        run: |
          mkdir -p docs/reports/weekly
          if [ -d "reports/weekly" ]; then
            cp -r reports/weekly/*.json docs/reports/weekly/ 2>/dev/null || true
          fi

      - name: Commit and push
        if: steps.check-reports.outputs.reports_exist == 'true'
        run: |
          # ë¨¼ì € stashí•˜ê³  pull
          git stash --include-untracked || true
          git pull origin main --rebase || true
          git stash pop || true
          # ê·¸ ë‹¤ìŒ add & commit
          git add reports/weekly/ docs/reports/weekly/
          if git diff --staged --quiet; then
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            git commit -m "Weekly Insight $(date +'%Y-W%V')"
            git push
            echo "âœ… ì£¼ê°„ ì¸ì‚¬ì´íŠ¸ í‘¸ì‹œ ì™„ë£Œ"
          fi

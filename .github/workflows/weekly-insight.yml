name: Generate Weekly Insight

on:
  schedule:
    - cron: '0 18 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ UTC 18:00 â†’ KST ì›”ìš”ì¼ 03:00
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      force:
        description: 'ê°•ì œ ì¬ìƒì„± (ê¸°ì¡´ ë¦¬í¬íŠ¸ ë®ì–´ì“°ê¸°)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write

concurrency:
  group: weekly-insight
  cancel-in-progress: false

jobs:
  generate-weekly-insight:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Pull latest changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git pull origin main --rebase || true

      - name: Check daily reports
        id: check-reports
        run: |
          REPORTS_COUNT=$(ls -1 reports/2*.json 2>/dev/null | wc -l)
          if [ "$REPORTS_COUNT" -gt 0 ]; then
            echo "reports_exist=true" >> $GITHUB_OUTPUT
            echo "ğŸ“‚ ì¼ì¼ ë¦¬í¬íŠ¸ ${REPORTS_COUNT}ê°œ í™•ì¸"
          else
            echo "reports_exist=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ ì¼ì¼ ë¦¬í¬íŠ¸ ì—†ìŒ - ai-insight ì›Œí¬í”Œë¡œìš°ê°€ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤"
          fi

      - name: Setup Node.js
        if: steps.check-reports.outputs.reports_exist == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        if: steps.check-reports.outputs.reports_exist == 'true'
        run: npm install --production

      - name: Generate Weekly Insight
        if: steps.check-reports.outputs.reports_exist == 'true'
        run: |
          echo "ğŸ“… ì£¼ê°„ ì¸ì‚¬ì´íŠ¸ ìƒì„± ì‹œì‘..."
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            node generate-weekly-insight.js --force
          else
            node generate-weekly-insight.js
          fi
        timeout-minutes: 20

      - name: Move weekly reports to docs
        if: steps.check-reports.outputs.reports_exist == 'true'
        run: |
          mkdir -p docs/reports/weekly
          if [ -d "reports/weekly" ]; then
            cp -r reports/weekly/*.json docs/reports/weekly/ 2>/dev/null || true
          fi

      - name: Commit and push
        if: steps.check-reports.outputs.reports_exist == 'true'
        run: |
          git add reports/weekly/ docs/reports/weekly/
          if git diff --staged --quiet; then
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          else
            git stash --include-untracked
            git pull origin main --rebase
            # stash pop, conflict ë°œìƒ ì‹œ ìƒˆë¡œ ìƒì„±ëœ ë°ì´í„°(stash) ìš°ì„ 
            if ! git stash pop; then
              echo "âš ï¸ Conflict detected - using newly generated data"
              git checkout --ours reports/weekly/ 2>/dev/null || true
              git checkout --ours docs/reports/weekly/ 2>/dev/null || true
              git add reports/weekly/ docs/reports/weekly/
              git stash drop 2>/dev/null || true
            fi
            git add reports/weekly/ docs/reports/weekly/
            git diff --staged --quiet || git commit -m "Weekly Insight $(date +'%Y-W%V')"
            git push
            echo "âœ… ì£¼ê°„ ì¸ì‚¬ì´íŠ¸ í‘¸ì‹œ ì™„ë£Œ"
          fi
